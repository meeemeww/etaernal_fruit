<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mix Room - Eternal Fruit</title>

    <style>
        /* Reset & Body */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
        }

        /* Mixroom Background */
        #mixroom-container {
            width: 100vw;
            height: 100vh;
            background: url('../image/Purple_Background.png') center/cover no-repeat;
            position: relative;
            display: flex;
        }

        /* Back Button */
        .back-button {
            position: absolute;
            top: clamp(10px, 2vh, 30px);
            left: clamp(10px, 2vw, 30px);
            width: clamp(45px, 4vw, 80px);
            height: clamp(45px, 4vw, 80px);
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #79138b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: clamp(18px, 1.5vw, 32px);
            color: #79138b;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            z-index: 10;
        }

        .back-button:hover,
        .back-button:active {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }

        /* Icons */
        #Marble_icon,
        #Book_icon {
            position: fixed;
            cursor: pointer;
            z-index: 100;
            transition: transform 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        #Marble_icon { 
            bottom: clamp(20px, 3vh, 50px); 
            left: clamp(150px, 18vw, 380px); 
            width: clamp(80px, 9vw, 180px);
            height: auto;
        }
        #Book_icon { 
            top: clamp(250px, 45vh, 500px); 
            right: clamp(250px, 28vw, 580px); 
            width: clamp(100px, 11vw, 220px);
            height: auto;
        }

        #Marble_icon:hover,
        #Book_icon:hover,
        #Marble_icon:active,
        #Book_icon:active {
            transform: scale(1.1);
        }

        /* Ultra-Wide Desktop (2560px and above) */
        @media (min-width: 2560px) {
            #Marble_icon {
                width: clamp(180px, 10vw, 240px);
                left: clamp(350px, 20vw, 450px);
            }

            #Book_icon {
                width: clamp(200px, 12vw, 280px);
                right: clamp(550px, 30vw, 700px);
            }

            .popup-content {
                width: clamp(550px, 38vw, 800px);
                max-width: min(50vw, 800px);
            }
        }

        /* Large Desktop (1920px - 2559px) */
        @media (min-width: 1920px) and (max-width: 2559px) {
            #Marble_icon {
                width: clamp(160px, 9.5vw, 200px);
            }

            #Book_icon {
                width: clamp(180px, 11vw, 250px);
            }

            .popup-content {
                width: clamp(500px, 40vw, 700px);
                max-width: min(52vw, 700px);
            }
        }

        /* Standard Desktop (1366px - 1919px) */
        @media (min-width: 1366px) and (max-width: 1919px) {
            .popup-content {
                width: clamp(420px, 44vw, 600px);
                max-width: min(54vw, 600px);
            }
        }

        /* Laptop (1025px - 1365px) */
        @media (min-width: 1025px) and (max-width: 1365px) {
            .popup-content {
                width: clamp(360px, 48vw, 550px);
                max-width: min(58vw, 550px);
            }
        }

        /* Popup styling */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .popup-content {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: transparent;
            width: clamp(260px, 45vw, 650px);
            max-width: min(55vw, 650px);
        }



        /* Tablet (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            #Marble_icon {
                width: clamp(90px, 14vw, 140px);
                left: clamp(120px, 16vw, 200px);
            }

            #Book_icon {
                width: clamp(110px, 15vw, 170px);
                right: clamp(180px, 25vw, 320px);
            }

            .popup-content {
                width: clamp(320px, 52vw, 480px);
                max-width: 62vw;
            }
        }

        /* Mobile & Small Tablet (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            #Marble_icon {
                width: clamp(70px, 16vw, 110px);
                left: clamp(80px, 12vw, 140px);
                bottom: clamp(15px, 2.5vh, 35px);
            }

            #Book_icon {
                width: clamp(85px, 18vw, 130px);
                right: clamp(120px, 20vw, 200px);
                top: clamp(180px, 35vh, 300px);
            }

            .popup-content {
                width: 95vw;
                max-width: 95vw;
            }
        }

        /* Small Mobile (up to 480px) */
        @media (max-width: 480px) {
            #Marble_icon {
                width: clamp(60px, 18vw, 90px);
                left: clamp(50px, 10vw, 100px);
                bottom: clamp(10px, 2vh, 25px);
            }

            #Book_icon {
                width: clamp(70px, 20vw, 110px);
                right: clamp(80px, 15vw, 140px);
                top: clamp(150px, 30vh, 250px);
            }

            .popup-content {
                width: 98vw;
                max-width: 98vw;
            }
        }

        /* Landscape Mode */
        @media (max-height: 600px) and (orientation: landscape) {
            #Marble_icon {
                width: clamp(50px, 10vh, 90px);
                bottom: clamp(8px, 1.5vh, 20px);
            }

            #Book_icon {
                width: clamp(60px, 12vh, 110px);
                top: clamp(100px, 25vh, 180px);
            }
        }
    </style>
</head>



<body>
    <div id="mixroom-container">
        <div class="back-button" onclick="goBack()">←</div>
    </div>

    <!-- Icons -->
    <img id="Marble_icon" src="../image/Marble_icon.png" alt="Marble" onclick="openPopup('MarblePopup')">
    <img id="Book_icon" src="../image/Book_icon.png" alt="Book" onclick="openPopup('BookPopup')">

    <!-- Popups -->
    <div id="MarblePopup" class="popup">
        <div class="popup-content" style="position: relative;">
            <img src="../image/mixing.png?v=20251126999" alt="Marble" style="width: 100%; height: auto; object-fit: contain; display: block;">
            <!-- Fruit Selection Grid -->
            <div id="fruit-grid" style="position: absolute; top: 20%; left: 12%; width: 18%; height: 26%; display: flex; align-items: center; justify-content: center; padding: 0px; overflow: visible; border: 2px solid transparent;">
            </div>
            <!-- Ore Selection Grid -->
            <div id="ore-grid" style="position: absolute; top: 20%; left: 36%; width: 18%; height: 26%; display: flex; align-items: center; justify-content: center; padding: 0px; overflow: visible; border: 2px solid transparent;">
            </div>
            <!-- Result Grid -->
            <div id="result-grid" style="position: absolute; top: 22%; left: 60%; width: 30%; height: 30%; display: flex; align-items: center; justify-content: center; padding: 0px; overflow: visible; background: #300F00; border: none;">
            </div>
            <!-- Mix Button -->
            <button onclick="mixItems()" style="position: absolute; top: 55%; left: 50%; transform: translateX(-50%); width: 25%; height: 9%; background: transparent; border: none; font-size: 0px; cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation;"></button>
            <!-- Inventory Grid -->
            <div id="mixing-inventory" style="position: absolute; bottom: 11%; left: 50%; transform: translateX(-50%); width: 78%; height: 24%; display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(2, 1fr); gap: 1%; padding: 0px; overflow: visible;">
            </div>
            <!-- Close Button Area -->
            <div onclick="closePopup('MarblePopup')" style="position: absolute; top: 5%; right: 6%; width: 7%; height: 11%; cursor: pointer; z-index: 99999; background: transparent; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0px; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">×</div>
        </div>
    </div>

    <div id="BookPopup" class="popup">
        <div class="popup-content" style="position: relative;">
            <img src="../image/Eternal_book.png" alt="Book" style="width: 100%; height: auto; max-height: 95vh; object-fit: contain; display: block;">
            <div onclick="closePopup('BookPopup')" style="position: absolute; top: 3%; right: 3%; width: clamp(40px, 5vw, 60px); height: clamp(40px, 5vw, 60px); cursor: pointer; z-index: 1001; background: transparent; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0px; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">×</div>
        </div>
    </div>


    <script src="../script.js"></script>
    <script>
        // Back button
        function goBack() { window.location.href = '../game.html'; }

        // เปิด/ปิด popup ด้วย id
        function openPopup(id) { 
            document.getElementById(id).style.display = 'flex';
            if (id === 'MarblePopup') {
                loadMixingInventory();
            }
        }
        function closePopup(id) { document.getElementById(id).style.display = 'none'; }

        // โหลด inventory ลงใน mixing popup
        function loadMixingInventory() {
            const inventoryKey = getUserInventoryKey();
            let inventory = JSON.parse(localStorage.getItem(inventoryKey)) || [];
            const uniqueInventory = [];
            const seenIds = new Set();
            
            inventory.forEach(item => {
                const itemId = item.id || item.name;
                if (!seenIds.has(itemId)) {
                    seenIds.add(itemId);
                    uniqueInventory.push(item);
                }
            });

            const container = document.getElementById('mixing-inventory');
            container.innerHTML = '';

            uniqueInventory.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.position = 'relative';
                itemDiv.style.textAlign = 'center';
                itemDiv.style.background = 'transparent';
                itemDiv.style.borderRadius = '10px';
                itemDiv.style.padding = '0px';
                itemDiv.style.border = '0px';
                itemDiv.style.outline = 'none';
                itemDiv.style.transition = 'all 0.3s';
                itemDiv.style.cursor = 'pointer';
                itemDiv.style.display = 'flex';
                itemDiv.style.alignItems = 'center';
                itemDiv.style.justifyContent = 'center';
                
                const itemImg = document.createElement('img');
                let imagePath = item.image.replace('../', '');
                itemImg.src = '../' + imagePath;
                itemImg.alt = item.name;
                itemImg.style.width = '45px';
                itemImg.style.height = '45px';
                itemImg.style.objectFit = 'contain';
                itemImg.style.filter = 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))';
                
                // เพิ่ม click handler สำหรับผลไม้
                if (item.name === 'รูป1' || item.name === 'รูป2' || item.name === 'รูป3') {
                    itemDiv.onclick = () => {
                        addToFruitGrid(item);
                    };
                }
                // เพิ่ม click handler สำหรับแร่
                else if (item.name === 'copper' || item.name === 'silver' || item.name === 'gold' || 
                         item.name === 'soil' || item.name === 'water' || item.name === 'fire' || item.name === 'air') {
                    itemDiv.onclick = () => {
                        addToOreGrid(item);
                    };
                }
                
                itemDiv.onmouseover = () => {
                    itemDiv.style.background = 'rgba(255, 215, 0, 0.2)';
                    itemDiv.style.transform = 'scale(1.1)';
                };
                itemDiv.onmouseout = () => {
                    itemDiv.style.background = 'transparent';
                    itemDiv.style.transform = 'scale(1)';
                };
                
                itemDiv.appendChild(itemImg);
                container.appendChild(itemDiv);
            });
        }

        // เพิ่มผลไม้ลงกรอบบน
        function addToFruitGrid(item) {
            const fruitGrid = document.getElementById('fruit-grid');
            
            // เช็คว่ามีผลไม้อยู่แล้วหรือไม่ (ห้ามเอาเข้าซ้ำ)
            if (fruitGrid.children.length >= 1) {
                alert('ใส่ได้แค่ผลไม้อันเดียวเท่านั้น!');
                return;
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.style.position = 'relative';
            itemDiv.style.textAlign = 'center';
            itemDiv.style.background = 'transparent';
            itemDiv.style.borderRadius = '10px';
            itemDiv.style.padding = '0px';
            itemDiv.style.border = '0px';
            itemDiv.style.outline = 'none';
            itemDiv.style.cursor = 'pointer';
            itemDiv.style.display = 'flex';
            itemDiv.style.alignItems = 'center';
            itemDiv.style.justifyContent = 'center';
            
            const itemImg = document.createElement('img');
            let imagePath = item.image.replace('../', '');
            itemImg.src = '../' + imagePath;
            itemImg.alt = item.name;
            itemImg.style.width = '70px';
            itemImg.style.height = '70px';
            itemImg.style.objectFit = 'contain';
            itemImg.style.filter = 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))';
            
            // คลิกเพื่อลบออกจากกรอบบน
            itemDiv.onclick = () => {
                fruitGrid.removeChild(itemDiv);
            };
            
            itemDiv.appendChild(itemImg);
            fruitGrid.appendChild(itemDiv);
        }

        // เพิ่มแร่ลงกรอบม่วง
        function addToOreGrid(item) {
            const oreGrid = document.getElementById('ore-grid');
            
            // เช็คว่ามีแร่อยู่แล้วหรือไม่ (ห้ามเอาเข้าซ้ำ)
            if (oreGrid.children.length >= 1) {
                alert('ใส่ได้แค่แร่อันเดียวเท่านั้น!');
                return;
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.style.position = 'relative';
            itemDiv.style.textAlign = 'center';
            itemDiv.style.background = 'transparent';
            itemDiv.style.borderRadius = '10px';
            itemDiv.style.padding = '0px';
            itemDiv.style.border = '0px';
            itemDiv.style.outline = 'none';
            itemDiv.style.cursor = 'pointer';
            itemDiv.style.display = 'flex';
            itemDiv.style.alignItems = 'center';
            itemDiv.style.justifyContent = 'center';
            
            const itemImg = document.createElement('img');
            let imagePath = item.image.replace('../', '');
            itemImg.src = '../' + imagePath;
            itemImg.alt = item.name;
            itemImg.style.width = '110px';
            itemImg.style.height = '110px';
            itemImg.style.objectFit = 'contain';
            itemImg.style.filter = 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))';
            
            // คลิกเพื่อลบออกจากกรอบ
            itemDiv.onclick = () => {
                oreGrid.removeChild(itemDiv);
            };
            
            itemDiv.appendChild(itemImg);
            oreGrid.appendChild(itemDiv);
        }

        // ฟังก์ชัน Mix
        function mixItems() {
            const fruitGrid = document.getElementById('fruit-grid');
            const oreGrid = document.getElementById('ore-grid');
            const resultGrid = document.getElementById('result-grid');
            
            // เช็คว่ามีผลไม้และแร่ในกรอบหรือไม่
            if (fruitGrid.children.length === 0) {
                alert('กรุณาใส่ผลไม้ก่อน!');
                return;
            }
            if (oreGrid.children.length === 0) {
                alert('กรุณาใส่แร่ก่อน!');
                return;
            }
            
            // ดึงชื่อผลไม้และแร่
            const fruitImg = fruitGrid.querySelector('img');
            const oreImg = oreGrid.querySelector('img');
            const fruitName = fruitImg ? fruitImg.alt : '';
            const oreName = oreImg ? oreImg.alt : '';
            
            // ล้างกรอบผลลัพธ์
            resultGrid.innerHTML = '';
            
            // ตรวจสอบสูตร
            let resultImage = '';
            let resultName = '';
            
            if (fruitName === 'รูป2' && oreName === 'water') {
                resultImage = '../image/11.png';
                resultName = 'ผลไม้ 11';
            } else if (fruitName === 'รูป1' && oreName === 'water') {
                resultImage = '../image/12.png';
                resultName = 'ผลไม้ 12';
            } else if (fruitName === 'รูป3' && oreName === 'water') {
                resultImage = '../image/13.png';
                resultName = 'ผลไม้ 13';
            } else {
                alert('สูตรผิด! ไม่สามารถผสมได้');
                return;
            }
            
            // สร้างผลลัพธ์
            const resultDiv = document.createElement('div');
            resultDiv.style.display = 'flex';
            resultDiv.style.alignItems = 'center';
            resultDiv.style.justifyContent = 'center';
            
            const resultImg = document.createElement('img');
            resultImg.src = resultImage;
            resultImg.alt = resultName;
            resultImg.style.width = '55px';
            resultImg.style.height = '55px';
            resultImg.style.objectFit = 'contain';
            resultImg.style.filter = 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))';
            
            resultDiv.appendChild(resultImg);
            resultGrid.appendChild(resultDiv);
            
            // บันทึกผลไม้ที่ mix ได้ลง localStorage
            const username = getCurrentUsername();
            if (username) {
                const mixedFruitsKey = 'mixedFruits_' + username;
                let mixedFruits = JSON.parse(localStorage.getItem(mixedFruitsKey)) || [];
                
                // เพิ่มผลไม้ที่ mix ได้
                mixedFruits.push({
                    name: resultName,
                    image: resultImage,
                    id: Date.now()
                });
                
                localStorage.setItem(mixedFruitsKey, JSON.stringify(mixedFruits));
            }
            
            // แสดงข้อความสำเร็จ
            setTimeout(() => {
                alert('ผสมสำเร็จ!');
            }, 500);
        }

        // คลิกพื้นหลังปิด popup
        window.addEventListener('click', function(e) {
            ['MarblePopup','BookPopup'].forEach(id => {
                const popup = document.getElementById(id);
                if (e.target === popup) popup.style.display = 'none';
            });
        });

        
    </script>
</body>
</html>
